"use strict";
const fs_1 = require('fs');
const zlib_1 = require('zlib');
const path_1 = require('path');
const Long = require('long');
const bzip = require('seek-bzip');
const mpqUserDataHeader_1 = require('./mpqUserDataHeader');
const mpqBlockTableEntry_1 = require('./mpqBlockTableEntry');
const mpqHashTableEntry_1 = require('./mpqHashTableEntry');
const mpqFileHeaders_1 = require('./mpqFileHeaders');
const mpqFileHeaderExt_1 = require('./mpqFileHeaderExt');
const MPQ_FILE_IMPLODE = 0x00000100;
const MPQ_FILE_COMPRESS = 0x00000200;
const MPQ_FILE_ENCRYPTED = 0x00010000;
const MPQ_FILE_FIX_KEY = 0x00020000;
const MPQ_FILE_SINGLE_UNIT = 0x01000000;
const MPQ_FILE_DELETE_MARKER = 0x02000000;
const MPQ_FILE_SECTOR_CRC = 0x04000000;
const MPQ_FILE_EXISTS = 0x80000000;
class MPQArchive {
    constructor(fileName, listFile) {
        this.printHashTable = function () {
            console.log('MPQ archive hash table');
            console.log('----------------------');
            console.log('Hash A\t\tHash B\t\tLocl\tPlat\tBlockIdx');
            let format = [8, 8, 4, 4, 8];
            this.hashTable.forEach(entry => {
                console.log(Object.keys(entry).map((key, i) => {
                    return this.formatWord(entry[key], format[i]);
                }).join('\t'));
            });
            console.log();
        };
        this.printBlockTable = function () {
            console.log('MPQ archive block table');
            console.log('-----------------------');
            console.log('Offset\t\tArchSize\tRealSize\tFlags');
            this.blockTable.forEach(entry => {
                console.log([
                    this.formatWord(entry.offset, 8),
                    this.leadingChar(entry.archivedSize, ' ', 8),
                    this.leadingChar(entry.size, ' ', 8),
                    this.formatWord(entry.flags, 8)
                ].join('\t'));
            });
            console.log();
        };
        this.printFiles = function () {
            let width = this.files.reduce((top, filename) => Math.max(top, filename.length), 0), hashEntry, blockEntry;
            console.log('Files');
            console.log('-----');
            for (let filename of this.files) {
                hashEntry = this.getHashTableEntry(filename);
                blockEntry = this.blockTable[hashEntry.blockTableIndex];
                console.log(this.leadingChar(filename, ' ', width, true) + ' ' + this.leadingChar(blockEntry.size, ' ', 8) + ' bytes');
            }
        };
        console.log('listfile listfile');
        if (typeof listFile === 'undefined')
            this.listfile = true;
        if (fileName instanceof Buffer) {
            this.file = fileName;
            this.fileName = '';
        }
        else {
            this.fileName = fileName;
            this.file = fs_1.readFileSync(fileName);
        }
        this.header = this.readHeader();
        this.hashTable = this.readTable(TableType.hash);
        this.blockTable = this.readTable(TableType.block);
        if (this.listfile) {
            this.files = this.readFile('(listfile)').toString().trim().split('\r\n');
        }
        else {
            this.files = null;
        }
    }
    get encryptionTable() {
        let table = {};
        let seed = Long.fromValue(0x00100001);
        for (let i = 0; i < 256; i += 1) {
            let index = i;
            for (let j = 0; j < 5; j += 1) {
                seed = seed.mul(125).add(3).mod(0x2AAAAB);
                let t1 = seed.and(0xFFFF).shiftLeft(0x10);
                seed = seed.mul(125).add(3).mod(0x2AAAAB);
                let t2 = seed.and(0xFFFF);
                table[index] = t1.or(t2).toNumber();
                index += 0x100;
            }
        }
        return table;
    }
    readHeader() {
        let magic = this.file.toString('utf8', 0, 4);
        let header;
        if (magic === 'MPQ\x1a') {
            header = this.readMPQHeader();
            header.offset = 0;
        }
        else {
            let userDataHeader = this.readMPQUserDataHeader();
            header = this.readMPQHeader(userDataHeader.mpqHeaderOffset);
            header.offset = userDataHeader.mpqHeaderOffset;
            header.userDataHeader = userDataHeader;
        }
        return header;
    }
    readMPQHeader(offset = 0) {
        let data = this.file.slice(offset, offset + 32);
        let header = new mpqFileHeaders_1.MPQFileHeader(data);
        if (header.formatVersion === 1) {
            let extData = this.file.slice(offset + 32, offset + 32 + 12);
            Object.assign(header, new mpqFileHeaderExt_1.MPQFileHeaderExt(extData));
        }
        return header;
    }
    readMPQUserDataHeader() {
        let data = this.file.slice(0, 16);
        let header = new mpqUserDataHeader_1.MPQUserDataHeader(data);
        header.content = this.file.slice(16, 16 + header.userDataHeaderSize);
        return header;
    }
    readTable(tableType) {
        let type;
        switch (tableType) {
            case TableType.block:
                type = mpqBlockTableEntry_1.MPQBlockTableEntry;
                break;
            case TableType.hash:
                type = mpqHashTableEntry_1.MPQHashTableEntry;
                break;
            default:
                throw new Error('Invalid Table Type');
        }
        let tableOffset = this.header[TableType[tableType] + 'TableOffset'];
        let tableEntries = this.header[TableType[tableType] + 'TableEntries'];
        let key = this.hash(`(${TableType[tableType]} table)`, 'TABLE');
        let data = this.file.slice(tableOffset + this.header.offset, tableOffset + this.header.offset + tableEntries * 16);
        data = this.decrypt(data, key);
        let entries = [];
        for (let i = 0; i < tableEntries; i += 1) {
            entries[i] = new type(data.slice(i * 16, i * 16 + 16));
        }
        return entries;
    }
    getHashTableEntry(filename) {
        let hashA = this.hash(filename, 'HASH_A');
        let hashB = this.hash(filename, 'HASH_B');
        let entry = this.hashTable.find(te => te.hashA === hashA && te.hashB === hashB);
        return entry;
    }
    decompress(data) {
        let compressionType = data.readUInt8(0);
        if (compressionType === 0)
            return data;
        else if (compressionType === 2)
            return zlib_1.unzipSync(data.slice(1));
        else if (compressionType === 16)
            return bzip.decode(data.slice(1));
        else
            throw new Error('Unsupported Compression Type');
    }
    readFile(filename, forceDecompress) {
        let hashEntry = this.getHashTableEntry(filename);
        if (!hashEntry)
            return null;
        let blockEntry = this.blockTable[hashEntry.blockTableIndex];
        if (blockEntry.flags & MPQ_FILE_EXISTS) {
            if (blockEntry.archivedSize === 0)
                return null;
            let offset = blockEntry.offset + this.header.offset;
            let fileData = this.file.slice(offset, offset + blockEntry.archivedSize);
            if (blockEntry.flags & MPQ_FILE_ENCRYPTED) {
                throw new Error('Encryption not supported');
            }
            if (!(blockEntry.flags & MPQ_FILE_SINGLE_UNIT)) {
                // throw new Error('Single Unit not implemented');
                let sectorSize = 512 << this.header.sectorSizeShift;
                let sectors = Math.trunc(blockEntry.size / sectorSize) + 1;
                let crc;
                if (blockEntry.flags & MPQ_FILE_SECTOR_CRC) {
                    crc = true;
                    sectors++;
                }
                else {
                    crc = false;
                }
                let positions = [], i;
                for (i = 0; i < (sectors + i); i += 1) {
                    positions[i] = fileData.readUInt32LE(i * 4);
                }
                let ln = positions.length - (crc ? 2 : 1);
                let result = new Buffer(0);
                let sectorBytesLeft = blockEntry.size;
                for (i = 0; i < ln; i += 1) {
                    let sector = fileData.slice(positions[i], positions[i + 1]);
                    if ((blockEntry.flags & MPQ_FILE_COMPRESS) && (forceDecompress || (sectorBytesLeft > sector.length))) {
                        sector = this.decompress(sector);
                    }
                    sectorBytesLeft -= sector.length;
                    result = Buffer.concat([result, sector]);
                }
                fileData = result;
            }
            else {
                if ((blockEntry.flags & MPQ_FILE_COMPRESS) && (forceDecompress || (blockEntry.size > blockEntry.archivedSize))) {
                    fileData = this.decompress(fileData);
                }
            }
            return fileData;
        }
    }
    extract() {
        if (this.files) {
            return this.files.map(filename => [filename, this.readFile(filename)]);
        }
        else {
            throw new Error('Can\'t extract whole archive without listfile.');
        }
    }
    extractToDisc() {
        let extension = path_1.extname(this.fileName);
        let archiveName = path_1.basename(this.fileName, extension);
        let dirName = path_1.join(process.cwd(), archiveName);
        try {
            fs_1.statSync(dirName);
        }
        catch (e) {
            fs_1.mkdirSync(dirName);
        }
        process.chdir(archiveName);
        this.extract().forEach(pair => {
            fs_1.writeFileSync(pair[0], pair[1] || '');
        });
    }
    extractFiles(filenames) {
        filenames.forEach(fn => fs_1.writeFileSync(fn, this.readFile(fn)));
    }
    printHeaders() {
        console.log('MPQ archive header');
        console.log('------------------');
        for (let key in this.header) {
            if (key === 'userDataHeader')
                continue;
            console.log(key + ' - ' + this.header[key]);
        }
        if (this.header.userDataHeader) {
            console.log();
            console.log('MPQ user data header');
            console.log('--------------------');
            console.log();
            for (let key in this.header.userDataHeader) {
                console.log(key + ' - ' + this.header.userDataHeader[key]);
            }
        }
        console.log();
    }
    leadingChar(str, ch, ln, after) {
        str = '' + str;
        while (str.length < ln) {
            str = after ? str + ch : ch + str;
        }
        return str;
    }
    formatWord(data, ln) {
        return this.leadingChar(data.toString(16).toUpperCase(), '0', ln);
    }
    hash(str, hashType) {
        let seed1 = Long.fromValue(0x7FED7FED);
        let seed2 = Long.fromValue(0xEEEEEEEE);
        let value;
        for (let char of str.toUpperCase()) {
            let charCP;
            if (isNaN(parseInt(char, 10)))
                char = char.codePointAt(0);
            value = Long.fromValue(this.encryptionTable[(hashTypes[hashType] << 8) + char]);
            seed1 = value.xor(seed1.add(seed2)).and(0xFFFFFFFF);
            seed2 = seed1.add(seed2).add(char).add(seed2.shiftLeft(5)).add(3).and(0xFFFFFFFF);
        }
        return seed1.toNumber();
    }
    decrypt(data, key) {
        let result = new Buffer(data.length);
        let length = data.length / 4;
        let seed1 = Long.fromValue(key);
        let seed2 = Long.fromValue(0xEEEEEEEE);
        for (let i = 0; i < length; i += 1) {
            seed2 = seed2.add(this.encryptionTable[0x400 + (seed1 & 0xFF)]);
            seed2 = seed2.and(0xFFFFFFFF);
            let value = Long.fromValue(data.readUInt32LE(i * 4));
            value = value.xor(seed1.add(seed2)).and(0xFFFFFFFF);
            seed1 = seed1.xor(-1).shiftLeft(0x15).add(0x11111111).or(seed1.shiftRight(0x0B));
            seed1 = seed1.and(0xFFFFFFFF);
            seed2 = value.add(seed2).add(seed2.shiftLeft(5)).add(3).and(0xFFFFFFFF);
            result.writeUInt32BE(value.toNumber(), i * 4);
        }
        return result;
    }
}
exports.MPQArchive = MPQArchive;
var TableType;
(function (TableType) {
    TableType[TableType["Unknown"] = 0] = "Unknown";
    TableType[TableType["hash"] = 1] = "hash";
    TableType[TableType["block"] = 2] = "block";
})(TableType || (TableType = {}));
const hashTypes = {
    'TABLE_OFFSET': 0,
    'HASH_A': 1,
    'HASH_B': 2,
    'TABLE': 3
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tcHEvbW9kZWxzL21wcUFyY2hpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHFCQUFpRSxJQUFJLENBQUMsQ0FBQTtBQUN0RSx1QkFBMEIsTUFBTSxDQUFDLENBQUE7QUFDakMsdUJBQXdDLE1BQU0sQ0FBQyxDQUFBO0FBQy9DLE1BQVksSUFBSSxXQUFNLE1BQU0sQ0FBQyxDQUFBO0FBRTdCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUVsQyxvQ0FBa0MscUJBQXFCLENBQUMsQ0FBQTtBQUN4RCxxQ0FBbUMsc0JBQXNCLENBQUMsQ0FBQTtBQUMxRCxvQ0FBa0MscUJBQXFCLENBQUMsQ0FBQTtBQUN4RCxpQ0FBOEIsa0JBQWtCLENBQUMsQ0FBQTtBQUNqRCxtQ0FBaUMsb0JBQW9CLENBQUMsQ0FBQTtBQUN0RCxNQUFNLGdCQUFnQixHQUFRLFVBQVUsQ0FBQztBQUN6QyxNQUFNLGlCQUFpQixHQUFPLFVBQVUsQ0FBQztBQUN6QyxNQUFNLGtCQUFrQixHQUFPLFVBQVUsQ0FBQztBQUMxQyxNQUFNLGdCQUFnQixHQUFPLFVBQVUsQ0FBQztBQUN4QyxNQUFNLG9CQUFvQixHQUFJLFVBQVUsQ0FBQztBQUN6QyxNQUFNLHNCQUFzQixHQUFHLFVBQVUsQ0FBQztBQUMxQyxNQUFNLG1CQUFtQixHQUFPLFVBQVUsQ0FBQztBQUMzQyxNQUFNLGVBQWUsR0FBVSxVQUFVLENBQUM7QUFFMUM7SUErQkUsWUFBWSxRQUF5QixFQUFFLFFBQWtCO1FBOE5sRCxtQkFBYyxHQUFHO1lBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QixDQUFDLENBQUM7WUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO1lBQ3hELElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUs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QUM7UUFFN0IsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3ZDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNuQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssR0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEUsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDOUIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JELEtBQUssR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7WUFFcEQsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDakYsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDOUIsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRXhFLE1BQU0sQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNoRCxDQUFDO1FBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNoQixDQUFDO0FBSUgsQ0FBQztBQTdVWSxrQkFBVSxhQTZVdEIsQ0FBQTtBQUdELElBQUssU0FJSjtBQUpELFdBQUssU0FBUztJQUNaLCtDQUFPLENBQUE7SUFDUCx5Q0FBSSxDQUFBO0lBQ0osMkNBQUssQ0FBQTtBQUNQLENBQUMsRUFKSSxTQUFTLEtBQVQsU0FBUyxRQUliO0FBRUQsTUFBTSxTQUFTLEdBQUc7SUFDakIsY0FBYyxFQUFFLENBQUM7SUFDakIsUUFBUSxFQUFJLENBQUM7SUFDYixRQUFRLEVBQUksQ0FBQztJQUNiLE9BQU8sRUFBSSxDQUFDO0NBQ1osQ0FBQyIsImZpbGUiOiJzcmMvbXBxL21vZGVscy9tcHFBcmNoaXZlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVhZEZpbGVTeW5jLCBzdGF0U3luYywgd3JpdGVGaWxlU3luYywgbWtkaXJTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgdW56aXBTeW5jIH0gZnJvbSAnemxpYic7XG5pbXBvcnQgeyBleHRuYW1lLCBiYXNlbmFtZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgTG9uZyBmcm9tICdsb25nJztcblxuY29uc3QgYnppcCA9IHJlcXVpcmUoJ3NlZWstYnppcCcpO1xuXG5pbXBvcnQgeyBNUFFVc2VyRGF0YUhlYWRlciB9IGZyb20gJy4vbXBxVXNlckRhdGFIZWFkZXInO1xuaW1wb3J0IHsgTVBRQmxvY2tUYWJsZUVudHJ5IH0gZnJvbSAnLi9tcHFCbG9ja1RhYmxlRW50cnknO1xuaW1wb3J0IHsgTVBRSGFzaFRhYmxlRW50cnkgfSBmcm9tICcuL21wcUhhc2hUYWJsZUVudHJ5JztcbmltcG9ydCB7IE1QUUZpbGVIZWFkZXIgfSBmcm9tICcuL21wcUZpbGVIZWFkZXJzJztcbmltcG9ydCB7IE1QUUZpbGVIZWFkZXJFeHQgfSBmcm9tICcuL21wcUZpbGVIZWFkZXJFeHQnO1xuY29uc3QgTVBRX0ZJTEVfSU1QTE9ERSBcdFx0XHQgID0gMHgwMDAwMDEwMDtcbmNvbnN0IE1QUV9GSUxFX0NPTVBSRVNTIFx0XHQgID0gMHgwMDAwMDIwMDtcbmNvbnN0IE1QUV9GSUxFX0VOQ1JZUFRFRCBcdFx0ICA9IDB4MDAwMTAwMDA7XG5jb25zdCBNUFFfRklMRV9GSVhfS0VZXHRcdFx0ICA9IDB4MDAwMjAwMDA7XG5jb25zdCBNUFFfRklMRV9TSU5HTEVfVU5JVFx0XHQ9IDB4MDEwMDAwMDA7XG5jb25zdCBNUFFfRklMRV9ERUxFVEVfTUFSS0VSXHQ9IDB4MDIwMDAwMDA7XG5jb25zdCBNUFFfRklMRV9TRUNUT1JfQ1JDXHQgXHQgID0gMHgwNDAwMDAwMDtcbmNvbnN0IE1QUV9GSUxFX0VYSVNUU1x0XHQgXHQgICAgPSAweDgwMDAwMDAwO1xuXG5leHBvcnQgY2xhc3MgTVBRQXJjaGl2ZSB7XG4gIHB1YmxpYyBmaWxlTmFtZTogc3RyaW5nO1xuICBwdWJsaWMgZmlsZTogQnVmZmVyO1xuICBwdWJsaWMgZmlsZXM6IEFycmF5PHN0cmluZz47XG5cbiAgcHVibGljIGhlYWRlcjogTVBRRmlsZUhlYWRlcjtcbiAgcHVibGljIGhhc2hUYWJsZTogQXJyYXk8TVBRSGFzaFRhYmxlRW50cnk+O1xuICBwdWJsaWMgYmxvY2tUYWJsZTogQXJyYXk8TVBRQmxvY2tUYWJsZUVudHJ5PjtcblxuICBwcml2YXRlIGxpc3RmaWxlOiBib29sZWFuO1xuXG4gIGdldCBlbmNyeXB0aW9uVGFibGUoKTogYW55IHtcbiAgICBsZXQgdGFibGUgPSB7fTtcbiAgICBsZXQgc2VlZCA9IExvbmcuZnJvbVZhbHVlKDB4MDAxMDAwMDEpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNTY7IGkgKz0gMSkge1xuICAgICAgbGV0IGluZGV4ID0gaTtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgNTsgaiArPSAxKSB7XG4gICAgICAgIHNlZWQgPSBzZWVkLm11bCgxMjUpLmFkZCgzKS5tb2QoMHgyQUFBQUIpO1xuICAgICAgICBsZXQgdDEgPSBzZWVkLmFuZCgweEZGRkYpLnNoaWZ0TGVmdCgweDEwKTtcbiAgICAgICAgXG4gICAgICAgIHNlZWQgPSBzZWVkLm11bCgxMjUpLmFkZCgzKS5tb2QoMHgyQUFBQUIpO1xuICAgICAgICBsZXQgdDIgPSBzZWVkLmFuZCgweEZGRkYpO1xuICAgICAgICBcbiAgICAgICAgdGFibGVbaW5kZXhdID0gdDEub3IodDIpLnRvTnVtYmVyKCk7XG4gICAgICAgIGluZGV4ICs9IDB4MTAwO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGFibGU7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihmaWxlTmFtZTogc3RyaW5nIHwgQnVmZmVyLCBsaXN0RmlsZT86IGJvb2xlYW4pIHtcbiAgICBjb25zb2xlLmxvZygnbGlzdGZpbGUgbGlzdGZpbGUnKTtcblx0ICBpZiAodHlwZW9mIGxpc3RGaWxlID09PSAndW5kZWZpbmVkJykgdGhpcy5saXN0ZmlsZSA9IHRydWU7XG5cblxuICAgIGlmIChmaWxlTmFtZSBpbnN0YW5jZW9mIEJ1ZmZlcikge1xuICAgICAgdGhpcy5maWxlID0gZmlsZU5hbWU7XG4gICAgICB0aGlzLmZpbGVOYW1lID0gJyc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZmlsZU5hbWUgPSBmaWxlTmFtZTtcbiAgICAgIHRoaXMuZmlsZSA9IHJlYWRGaWxlU3luYyhmaWxlTmFtZSk7XG4gICAgfVxuICAgIHRoaXMuaGVhZGVyID0gdGhpcy5yZWFkSGVhZGVyKCk7XG4gICAgdGhpcy5oYXNoVGFibGUgPSB0aGlzLnJlYWRUYWJsZShUYWJsZVR5cGUuaGFzaCk7XG4gICAgdGhpcy5ibG9ja1RhYmxlID0gdGhpcy5yZWFkVGFibGUoVGFibGVUeXBlLmJsb2NrKTtcbiAgICBcbiAgICBpZiAodGhpcy5saXN0ZmlsZSkge1xuICAgICAgdGhpcy5maWxlcyA9IHRoaXMucmVhZEZpbGUoJyhsaXN0ZmlsZSknKS50b1N0cmluZygpLnRyaW0oKS5zcGxpdCgnXFxyXFxuJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZmlsZXMgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVhZEhlYWRlcigpOiBNUFFGaWxlSGVhZGVyIHtcbiAgICBsZXQgbWFnaWMgPSB0aGlzLmZpbGUudG9TdHJpbmcoJ3V0ZjgnLCAwLCA0KTtcbiAgICBsZXQgaGVhZGVyOiBNUFFGaWxlSGVhZGVyO1xuICAgIGlmIChtYWdpYyA9PT0gJ01QUVxceDFhJykge1xuICAgICAgaGVhZGVyID0gdGhpcy5yZWFkTVBRSGVhZGVyKCk7XG4gICAgICBoZWFkZXIub2Zmc2V0ID0gMDtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHVzZXJEYXRhSGVhZGVyOiBNUFFVc2VyRGF0YUhlYWRlciA9IHRoaXMucmVhZE1QUVVzZXJEYXRhSGVhZGVyKCk7XG4gICAgICBoZWFkZXIgPSB0aGlzLnJlYWRNUFFIZWFkZXIodXNlckRhdGFIZWFkZXIubXBxSGVhZGVyT2Zmc2V0KTtcbiAgICAgIGhlYWRlci5vZmZzZXQgPSB1c2VyRGF0YUhlYWRlci5tcHFIZWFkZXJPZmZzZXQ7XG4gICAgICBoZWFkZXIudXNlckRhdGFIZWFkZXIgPSB1c2VyRGF0YUhlYWRlcjtcbiAgICB9XG5cbiAgICByZXR1cm4gaGVhZGVyO1xuICB9XG5cbiAgcHJpdmF0ZSByZWFkTVBRSGVhZGVyKG9mZnNldCA9IDApIHtcbiAgICBsZXQgZGF0YSA9IHRoaXMuZmlsZS5zbGljZShvZmZzZXQsIG9mZnNldCArIDMyKTtcbiAgICBsZXQgaGVhZGVyID0gbmV3IE1QUUZpbGVIZWFkZXIoZGF0YSk7XG5cbiAgICBpZiAoaGVhZGVyLmZvcm1hdFZlcnNpb24gPT09IDEpIHtcbiAgICAgIGxldCBleHREYXRhID0gdGhpcy5maWxlLnNsaWNlKG9mZnNldCArIDMyLCBvZmZzZXQgKyAzMiArIDEyKTtcbiAgICAgIE9iamVjdC5hc3NpZ24oaGVhZGVyLCBuZXcgTVBRRmlsZUhlYWRlckV4dChleHREYXRhKSk7XG4gICAgfVxuICAgIHJldHVybiBoZWFkZXI7XG4gIH1cblxuICBwcml2YXRlIHJlYWRNUFFVc2VyRGF0YUhlYWRlcigpIHtcbiAgICBsZXQgZGF0YSA9IHRoaXMuZmlsZS5zbGljZSgwLCAxNik7XG4gICAgbGV0IGhlYWRlciA9IG5ldyBNUFFVc2VyRGF0YUhlYWRlcihkYXRhKTtcbiAgICBoZWFkZXIuY29udGVudCA9IHRoaXMuZmlsZS5zbGljZSgxNiwgMTYgKyBoZWFkZXIudXNlckRhdGFIZWFkZXJTaXplKTtcblxuICAgIHJldHVybiBoZWFkZXI7XG4gIH1cblxuICBwcml2YXRlIHJlYWRUYWJsZSh0YWJsZVR5cGU6IFRhYmxlVHlwZSkge1xuICAgIGxldCB0eXBlO1xuICAgIHN3aXRjaCAodGFibGVUeXBlKSB7XG4gICAgICBjYXNlIFRhYmxlVHlwZS5ibG9jazpcbiAgICAgICAgdHlwZSA9IE1QUUJsb2NrVGFibGVFbnRyeTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRhYmxlVHlwZS5oYXNoOlxuICAgICAgICB0eXBlID0gTVBRSGFzaFRhYmxlRW50cnk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIFRhYmxlIFR5cGUnKTtcbiAgICB9XG5cbiAgICBsZXQgdGFibGVPZmZzZXQgPSB0aGlzLmhlYWRlcltUYWJsZVR5cGVbdGFibGVUeXBlXSArICdUYWJsZU9mZnNldCddO1xuICAgIGxldCB0YWJsZUVudHJpZXMgPSB0aGlzLmhlYWRlcltUYWJsZVR5cGVbdGFibGVUeXBlXSArICdUYWJsZUVudHJpZXMnXTtcbiAgICBsZXQga2V5ID0gdGhpcy5oYXNoKGAoJHtUYWJsZVR5cGVbdGFibGVUeXBlXX0gdGFibGUpYCwgJ1RBQkxFJyk7XG4gICAgbGV0IGRhdGEgPSB0aGlzLmZpbGUuc2xpY2UodGFibGVPZmZzZXQgKyB0aGlzLmhlYWRlci5vZmZzZXQsIHRhYmxlT2Zmc2V0ICsgdGhpcy5oZWFkZXIub2Zmc2V0ICsgdGFibGVFbnRyaWVzICogMTYpO1xuXG4gICAgZGF0YSA9IHRoaXMuZGVjcnlwdChkYXRhLCBrZXkpO1xuICAgIFxuICAgIGxldCBlbnRyaWVzID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YWJsZUVudHJpZXM7IGkgKz0gMSkge1xuICAgICAgZW50cmllc1tpXSA9IG5ldyB0eXBlKGRhdGEuc2xpY2UoaSAqIDE2LCBpICogMTYgKyAxNikpO1xuXHQgIH1cbiAgICByZXR1cm4gZW50cmllcztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SGFzaFRhYmxlRW50cnkoZmlsZW5hbWU6IHN0cmluZykge1xuICAgIGxldCBoYXNoQSA9IHRoaXMuaGFzaChmaWxlbmFtZSwgJ0hBU0hfQScpO1xuICAgIGxldCBoYXNoQiA9IHRoaXMuaGFzaChmaWxlbmFtZSwgJ0hBU0hfQicpO1xuXG4gICAgbGV0IGVudHJ5ID0gdGhpcy5oYXNoVGFibGUuZmluZCh0ZSA9PiB0ZS5oYXNoQSA9PT0gaGFzaEEgJiYgdGUuaGFzaEIgPT09IGhhc2hCKTtcbiAgICByZXR1cm4gZW50cnk7XG4gIH1cblxuICBwcml2YXRlIGRlY29tcHJlc3MoZGF0YTogQnVmZmVyKSB7XG4gICAgbGV0IGNvbXByZXNzaW9uVHlwZSA9IGRhdGEucmVhZFVJbnQ4KDApO1xuICAgIGlmIChjb21wcmVzc2lvblR5cGUgPT09IDApIHJldHVybiBkYXRhO1xuICAgIGVsc2UgaWYgKGNvbXByZXNzaW9uVHlwZSA9PT0gMikgcmV0dXJuIHVuemlwU3luYyhkYXRhLnNsaWNlKDEpKTtcbiAgICBlbHNlIGlmIChjb21wcmVzc2lvblR5cGUgPT09IDE2KSByZXR1cm4gYnppcC5kZWNvZGUoZGF0YS5zbGljZSgxKSk7XG4gICAgZWxzZSB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIENvbXByZXNzaW9uIFR5cGUnKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZEZpbGUoZmlsZW5hbWU6IHN0cmluZywgZm9yY2VEZWNvbXByZXNzPzogYm9vbGVhbik6IEJ1ZmZlciB7XG4gICAgbGV0IGhhc2hFbnRyeSA9IHRoaXMuZ2V0SGFzaFRhYmxlRW50cnkoZmlsZW5hbWUpO1xuICAgIGlmICghaGFzaEVudHJ5KSByZXR1cm4gbnVsbDtcblxuICAgIGxldCBibG9ja0VudHJ5ID0gdGhpcy5ibG9ja1RhYmxlW2hhc2hFbnRyeS5ibG9ja1RhYmxlSW5kZXhdO1xuXG4gICAgaWYgKGJsb2NrRW50cnkuZmxhZ3MgJiBNUFFfRklMRV9FWElTVFMpIHtcbiAgICAgIGlmIChibG9ja0VudHJ5LmFyY2hpdmVkU2l6ZSA9PT0gMCkgcmV0dXJuIG51bGw7XG5cbiAgICAgIGxldCBvZmZzZXQgPSBibG9ja0VudHJ5Lm9mZnNldCArIHRoaXMuaGVhZGVyLm9mZnNldDtcbiAgICAgIGxldCBmaWxlRGF0YSA9IHRoaXMuZmlsZS5zbGljZShvZmZzZXQsIG9mZnNldCArIGJsb2NrRW50cnkuYXJjaGl2ZWRTaXplKTtcblxuICAgICAgaWYgKGJsb2NrRW50cnkuZmxhZ3MgJiBNUFFfRklMRV9FTkNSWVBURUQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbmNyeXB0aW9uIG5vdCBzdXBwb3J0ZWQnKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCEoYmxvY2tFbnRyeS5mbGFncyAmIE1QUV9GSUxFX1NJTkdMRV9VTklUKSkge1xuICAgICAgICAvLyB0aHJvdyBuZXcgRXJyb3IoJ1NpbmdsZSBVbml0IG5vdCBpbXBsZW1lbnRlZCcpO1xuXG4gICAgICAgIGxldCBzZWN0b3JTaXplID0gNTEyIDw8IHRoaXMuaGVhZGVyLnNlY3RvclNpemVTaGlmdDtcbiAgICAgICAgbGV0IHNlY3RvcnMgPSBNYXRoLnRydW5jKGJsb2NrRW50cnkuc2l6ZSAvIHNlY3RvclNpemUpICsgMTtcblxuICAgICAgICBsZXQgY3JjO1xuXG4gICAgICAgIGlmIChibG9ja0VudHJ5LmZsYWdzICYgTVBRX0ZJTEVfU0VDVE9SX0NSQykge1xuICAgICAgICAgIGNyYyA9IHRydWU7XG4gICAgICAgICAgc2VjdG9ycysrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNyYyA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHBvc2l0aW9ucyA9IFtdLCBpO1xuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgKHNlY3RvcnMgKyBpKTsgaSArPSAxKSB7XG4gICAgICAgICAgcG9zaXRpb25zW2ldID0gZmlsZURhdGEucmVhZFVJbnQzMkxFKGkgKiA0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsbiA9IHBvc2l0aW9ucy5sZW5ndGggLSAoY3JjID8gMiA6IDEpO1xuICAgICAgICBsZXQgcmVzdWx0ID0gbmV3IEJ1ZmZlcigwKTtcbiAgICAgICAgbGV0IHNlY3RvckJ5dGVzTGVmdCA9IGJsb2NrRW50cnkuc2l6ZTtcblxuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbG47IGkrPSAxKSB7XG4gICAgICAgICAgbGV0IHNlY3RvciA9IGZpbGVEYXRhLnNsaWNlKHBvc2l0aW9uc1tpXSwgcG9zaXRpb25zW2kgKyAxXSk7XG4gICAgICAgICAgaWYgKChibG9ja0VudHJ5LmZsYWdzICYgTVBRX0ZJTEVfQ09NUFJFU1MpICYmIChmb3JjZURlY29tcHJlc3MgfHwgKHNlY3RvckJ5dGVzTGVmdCA+IHNlY3Rvci5sZW5ndGgpKSkge1xuICAgICAgICAgICAgc2VjdG9yID0gdGhpcy5kZWNvbXByZXNzKHNlY3Rvcik7XG4gICAgICAgICAgfVxuICAgICAgICAgIHNlY3RvckJ5dGVzTGVmdCAtPSBzZWN0b3IubGVuZ3RoO1xuXG4gICAgICAgICAgcmVzdWx0ID0gQnVmZmVyLmNvbmNhdChbcmVzdWx0LCBzZWN0b3JdKTtcbiAgICAgICAgfVxuICAgICAgICBmaWxlRGF0YSA9IHJlc3VsdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICgoYmxvY2tFbnRyeS5mbGFncyAmIE1QUV9GSUxFX0NPTVBSRVNTKSAmJiAoZm9yY2VEZWNvbXByZXNzIHx8IChibG9ja0VudHJ5LnNpemUgPiBibG9ja0VudHJ5LmFyY2hpdmVkU2l6ZSkpKSB7XG4gICAgICAgICAgZmlsZURhdGEgPSB0aGlzLmRlY29tcHJlc3MoZmlsZURhdGEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gZmlsZURhdGE7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0KCkge1xuICAgIGlmICh0aGlzLmZpbGVzKSB7XG4gICAgICByZXR1cm4gdGhpcy5maWxlcy5tYXAoZmlsZW5hbWUgPT4gW2ZpbGVuYW1lLCB0aGlzLnJlYWRGaWxlKGZpbGVuYW1lKV0pXG4gICAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhblxcJ3QgZXh0cmFjdCB3aG9sZSBhcmNoaXZlIHdpdGhvdXQgbGlzdGZpbGUuJyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0VG9EaXNjKCkge1xuICAgIGxldCBleHRlbnNpb24gPSBleHRuYW1lKHRoaXMuZmlsZU5hbWUpO1xuICAgIGxldCBhcmNoaXZlTmFtZSA9IGJhc2VuYW1lKHRoaXMuZmlsZU5hbWUsIGV4dGVuc2lvbik7XG4gICAgbGV0IGRpck5hbWUgPSBqb2luKHByb2Nlc3MuY3dkKCksIGFyY2hpdmVOYW1lKTtcblxuICAgIHRyeSB7XG4gICAgICBzdGF0U3luYyhkaXJOYW1lKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBta2RpclN5bmMoZGlyTmFtZSk7XG4gICAgfVxuXG4gICAgcHJvY2Vzcy5jaGRpcihhcmNoaXZlTmFtZSk7XG5cbiAgICB0aGlzLmV4dHJhY3QoKS5mb3JFYWNoKHBhaXIgPT4ge1xuICAgICAgd3JpdGVGaWxlU3luYyhwYWlyWzBdLCBwYWlyWzFdIHx8ICcnKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBleHRyYWN0RmlsZXMoZmlsZW5hbWVzOiBBcnJheTxzdHJpbmc+KSB7XG4gICAgZmlsZW5hbWVzLmZvckVhY2goZm4gPT4gd3JpdGVGaWxlU3luYyhmbiwgdGhpcy5yZWFkRmlsZShmbikpKTtcbiAgfVxuXG4gIHB1YmxpYyBwcmludEhlYWRlcnMoKSB7XG4gICAgY29uc29sZS5sb2coJ01QUSBhcmNoaXZlIGhlYWRlcicpO1xuICAgIGNvbnNvbGUubG9nKCctLS0tLS0tLS0tLS0tLS0tLS0nKTtcbiAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5oZWFkZXIpIHtcbiAgICAgIGlmIChrZXkgPT09ICd1c2VyRGF0YUhlYWRlcicpIGNvbnRpbnVlO1xuICAgICAgY29uc29sZS5sb2coa2V5ICsgJyAtICcgKyB0aGlzLmhlYWRlcltrZXldKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKHRoaXMuaGVhZGVyLnVzZXJEYXRhSGVhZGVyKSB7XG4gICAgICBjb25zb2xlLmxvZygpO1xuICAgICAgY29uc29sZS5sb2coJ01QUSB1c2VyIGRhdGEgaGVhZGVyJyk7XG4gICAgICBjb25zb2xlLmxvZygnLS0tLS0tLS0tLS0tLS0tLS0tLS0nKTtcbiAgICAgIGNvbnNvbGUubG9nKCk7XG4gICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5oZWFkZXIudXNlckRhdGFIZWFkZXIpIHtcbiAgICAgICAgY29uc29sZS5sb2coa2V5ICsgJyAtICcgKyB0aGlzLmhlYWRlci51c2VyRGF0YUhlYWRlcltrZXldKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc29sZS5sb2coKTtcbiAgfVxuXG4gIHByaXZhdGUgbGVhZGluZ0NoYXIoc3RyLCBjaCwgbG4sIGFmdGVyPykge1xuICAgIHN0ciA9ICcnICsgc3RyO1xuICAgIHdoaWxlIChzdHIubGVuZ3RoIDwgbG4pIHtcbiAgICAgIHN0ciA9IGFmdGVyID8gc3RyICsgY2ggOiBjaCArIHN0cjtcbiAgICB9XG4gICAgcmV0dXJuIHN0cjtcbiAgfVxuXG4gIHByaXZhdGUgZm9ybWF0V29yZChkYXRhLCBsbikge1xuICAgIHJldHVybiB0aGlzLmxlYWRpbmdDaGFyKGRhdGEudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCksICcwJywgbG4pO1xuICB9XG5cbiAgcHVibGljIHByaW50SGFzaFRhYmxlID0gZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ01QUSBhcmNoaXZlIGhhc2ggdGFibGUnKTtcbiAgICBjb25zb2xlLmxvZygnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScpO1xuICAgIGNvbnNvbGUubG9nKCdIYXNoIEFcXHRcXHRIYXNoIEJcXHRcXHRMb2NsXFx0UGxhdFxcdEJsb2NrSWR4Jyk7XG4gICAgbGV0IGZvcm1hdCA9IFs4LCA4LCA0LCA0LCA4XTtcbiAgICB0aGlzLmhhc2hUYWJsZS5mb3JFYWNoKGVudHJ5ID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKE9iamVjdC5rZXlzKGVudHJ5KS5tYXAoKGtleSwgaSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRXb3JkKGVudHJ5W2tleV0sIGZvcm1hdFtpXSk7XG4gICAgICB9KS5qb2luKCdcXHQnKSk7XG4gICAgfSk7XG4gICAgY29uc29sZS5sb2coKTtcbiAgfTtcblxuICBwdWJsaWMgcHJpbnRCbG9ja1RhYmxlID0gZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ01QUSBhcmNoaXZlIGJsb2NrIHRhYmxlJyk7XG4gICAgY29uc29sZS5sb2coJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJyk7XG4gICAgY29uc29sZS5sb2coJ09mZnNldFxcdFxcdEFyY2hTaXplXFx0UmVhbFNpemVcXHRGbGFncycpO1xuICAgIHRoaXMuYmxvY2tUYWJsZS5mb3JFYWNoKGVudHJ5ID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFtcbiAgICAgICAgdGhpcy5mb3JtYXRXb3JkKGVudHJ5Lm9mZnNldCwgOCksXG4gICAgICAgIHRoaXMubGVhZGluZ0NoYXIoZW50cnkuYXJjaGl2ZWRTaXplLCAnICcsIDgpLFxuICAgICAgICB0aGlzLmxlYWRpbmdDaGFyKGVudHJ5LnNpemUsICcgJywgOCksXG4gICAgICAgIHRoaXMuZm9ybWF0V29yZChlbnRyeS5mbGFncywgOClcbiAgICAgIF0uam9pbignXFx0JykpO1xuICAgIH0pO1xuICAgIGNvbnNvbGUubG9nKCk7XG4gIH07XG5cbiAgcHVibGljIHByaW50RmlsZXMgPSBmdW5jdGlvbigpIHtcbiAgICBsZXQgd2lkdGggPSB0aGlzLmZpbGVzLnJlZHVjZSgodG9wLCBmaWxlbmFtZSkgPT4gTWF0aC5tYXgodG9wLCBmaWxlbmFtZS5sZW5ndGgpLCAwKSwgaGFzaEVudHJ5LCBibG9ja0VudHJ5O1xuICAgIFxuICAgIGNvbnNvbGUubG9nKCdGaWxlcycpO1xuICAgIGNvbnNvbGUubG9nKCctLS0tLScpO1xuICAgIGZvciAobGV0IGZpbGVuYW1lIG9mIHRoaXMuZmlsZXMpIHtcbiAgICAgIGhhc2hFbnRyeSA9IHRoaXMuZ2V0SGFzaFRhYmxlRW50cnkoZmlsZW5hbWUpO1xuICAgICAgYmxvY2tFbnRyeSA9IHRoaXMuYmxvY2tUYWJsZVtoYXNoRW50cnkuYmxvY2tUYWJsZUluZGV4XTtcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2codGhpcy5sZWFkaW5nQ2hhcihmaWxlbmFtZSwgJyAnLCB3aWR0aCwgdHJ1ZSkgKyAnICcgKyB0aGlzLmxlYWRpbmdDaGFyKGJsb2NrRW50cnkuc2l6ZSwgJyAnLCA4KSArICcgYnl0ZXMnKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBoYXNoKHN0cjogc3RyaW5nLCBoYXNoVHlwZTogc3RyaW5nKSB7XG4gICAgbGV0IHNlZWQxID0gTG9uZy5mcm9tVmFsdWUoMHg3RkVEN0ZFRCk7XG4gICAgbGV0IHNlZWQyID0gTG9uZy5mcm9tVmFsdWUoMHhFRUVFRUVFRSk7XG4gICAgbGV0IHZhbHVlO1xuICAgIGZvciAobGV0IGNoYXIgb2Ygc3RyLnRvVXBwZXJDYXNlKCkpIHtcbiAgICAgIGxldCBjaGFyQ1A7XG4gICAgICBpZiAoaXNOYU4ocGFyc2VJbnQoY2hhciwgMTApKSkgY2hhciA9IGNoYXIuY29kZVBvaW50QXQoMCk7XG5cbiAgICAgIHZhbHVlID0gTG9uZy5mcm9tVmFsdWUodGhpcy5lbmNyeXB0aW9uVGFibGVbKGhhc2hUeXBlc1toYXNoVHlwZV0gPDwgOCkgKyBjaGFyXSk7XG4gICAgICBzZWVkMSA9IHZhbHVlLnhvcihzZWVkMS5hZGQoc2VlZDIpKS5hbmQoMHhGRkZGRkZGRik7XG4gICAgICBzZWVkMiA9IHNlZWQxLmFkZChzZWVkMikuYWRkKGNoYXIpLmFkZChzZWVkMi5zaGlmdExlZnQoNSkpLmFkZCgzKS5hbmQoMHhGRkZGRkZGRik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNlZWQxLnRvTnVtYmVyKCk7XG4gIH1cblxuICBwcml2YXRlIGRlY3J5cHQoZGF0YTogQnVmZmVyLCBrZXkpIHtcbiAgICBsZXQgcmVzdWx0ID0gbmV3IEJ1ZmZlcihkYXRhLmxlbmd0aCk7XG4gICAgbGV0IGxlbmd0aCA9IGRhdGEubGVuZ3RoIC8gNDtcblxuICAgIGxldCBzZWVkMSA9IExvbmcuZnJvbVZhbHVlKGtleSk7XG4gICAgbGV0IHNlZWQyID0gTG9uZy5mcm9tVmFsdWUoMHhFRUVFRUVFRSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkge1xuICAgICAgc2VlZDIgPSBzZWVkMi5hZGQodGhpcy5lbmNyeXB0aW9uVGFibGVbMHg0MDAgKyAoc2VlZDEgJiAweEZGKV0pO1xuICAgICAgc2VlZDIgPSBzZWVkMi5hbmQoMHhGRkZGRkZGRik7XG4gICAgICBsZXQgdmFsdWUgPSBMb25nLmZyb21WYWx1ZShkYXRhLnJlYWRVSW50MzJMRShpICogNCkpO1xuICAgICAgdmFsdWUgPSB2YWx1ZS54b3Ioc2VlZDEuYWRkKHNlZWQyKSkuYW5kKDB4RkZGRkZGRkYpO1xuICAgICAgXG4gICAgICBzZWVkMSA9IHNlZWQxLnhvcigtMSkuc2hpZnRMZWZ0KDB4MTUpLmFkZCgweDExMTExMTExKS5vcihzZWVkMS5zaGlmdFJpZ2h0KDB4MEIpKTtcbiAgICAgIHNlZWQxID0gc2VlZDEuYW5kKDB4RkZGRkZGRkYpO1xuICAgICAgc2VlZDIgPSB2YWx1ZS5hZGQoc2VlZDIpLmFkZChzZWVkMi5zaGlmdExlZnQoNSkpLmFkZCgzKS5hbmQoMHhGRkZGRkZGRik7XG4gICAgICBcbiAgICAgIHJlc3VsdC53cml0ZVVJbnQzMkJFKHZhbHVlLnRvTnVtYmVyKCksIGkgKiA0KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG5cblxufVxuXG5cbmVudW0gVGFibGVUeXBlIHtcbiAgVW5rbm93bixcbiAgaGFzaCxcbiAgYmxvY2tcbn1cblxuY29uc3QgaGFzaFR5cGVzID0ge1xuXHQnVEFCTEVfT0ZGU0VUJzogMCxcblx0J0hBU0hfQSc6IFx0XHQxLFxuXHQnSEFTSF9CJzogXHRcdDIsXG5cdCdUQUJMRSc6IFx0XHQzXG59OyJdfQ==
