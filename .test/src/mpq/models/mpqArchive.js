"use strict";
const fs_1 = require('fs');
const zlib_1 = require('zlib');
const path_1 = require('path');
const Long = require('long');
const bzip = require('seek-bzip');
const mpqUserDataHeader_1 = require('./mpqUserDataHeader');
const mpqBlockTableEntry_1 = require('./mpqBlockTableEntry');
const mpqHashTableEntry_1 = require('./mpqHashTableEntry');
const mpqFileHeaders_1 = require('./mpqFileHeaders');
const mpqFileHeaderExt_1 = require('./mpqFileHeaderExt');
const MPQ_FILE_IMPLODE = 0x00000100;
const MPQ_FILE_COMPRESS = 0x00000200;
const MPQ_FILE_ENCRYPTED = 0x00010000;
const MPQ_FILE_FIX_KEY = 0x00020000;
const MPQ_FILE_SINGLE_UNIT = 0x01000000;
const MPQ_FILE_DELETE_MARKER = 0x02000000;
const MPQ_FILE_SECTOR_CRC = 0x04000000;
const MPQ_FILE_EXISTS = 0x80000000;
class MPQArchive {
    constructor(fileName, listFile = false) {
        this.printHashTable = function () {
            console.log('MPQ archive hash table');
            console.log('----------------------');
            console.log('Hash A\t\tHash B\t\tLocl\tPlat\tBlockIdx');
            let format = [8, 8, 4, 4, 8];
            this.hashTable.forEach(entry => {
                console.log(Object.keys(entry).map((key, i) => {
                    return this.formatWord(entry[key], format[i]);
                }).join('\t'));
            });
            console.log();
        };
        this.printBlockTable = function () {
            console.log('MPQ archive block table');
            console.log('-----------------------');
            console.log('Offset\t\tArchSize\tRealSize\tFlags');
            this.blockTable.forEach(entry => {
                console.log([
                    this.formatWord(entry.offset, 8),
                    this.leadingChar(entry.archivedSize, ' ', 8),
                    this.leadingChar(entry.size, ' ', 8),
                    this.formatWord(entry.flags, 8)
                ].join('\t'));
            });
            console.log();
        };
        this.printFiles = function () {
            let width = this.files.reduce((top, filename) => Math.max(top, filename.length), 0), hashEntry, blockEntry;
            console.log('Files');
            console.log('-----');
            for (let filename of this.files) {
                hashEntry = this.getHashTableEntry(filename);
                blockEntry = this.blockTable[hashEntry.blockTableIndex];
                console.log(this.leadingChar(filename, ' ', width, true) + ' ' + this.leadingChar(blockEntry.size, ' ', 8) + ' bytes');
            }
        };
        this.listfile = !!listFile;
        if (fileName instanceof Buffer) {
            this.file = fileName;
            this.fileName = '';
        }
        else {
            this.fileName = fileName;
            this.file = fs_1.readFileSync(fileName);
        }
        this.header = this.readHeader();
        console.log(this.header);
        this.hashTable = this.readTable(TableType.hash);
        this.blockTable = this.readTable(TableType.block);
        if (this.listfile) {
            this.files = this.readFile('(listfile)').toString().trim().split('\r\n');
        }
        else {
            this.files = null;
        }
    }
    get encryptionTable() {
        let table = {};
        let seed = Long.fromValue(0x00100001);
        for (let i = 0; i < 256; i += 1) {
            let index = i;
            for (let j = 0; j < 5; j += 1) {
                seed = seed.mul(125).add(3).mod(0x2AAAAB);
                let t1 = seed.and(0xFFFF).shiftLeft(0x10);
                seed = seed.mul(125).add(3).mod(0x2AAAAB);
                let t2 = seed.and(0xFFFF);
                table[index] = t1.or(t2).toNumber();
                index += 0x100;
            }
        }
        return table;
    }
    readHeader() {
        let magic = this.file.toString('utf8', 0, 4);
        let header;
        if (magic === 'MPQ\x1a') {
            header = this.readMPQHeader();
            header.offset = 0;
        }
        else {
            let userDataHeader = this.readMPQUserDataHeader();
            header = this.readMPQHeader(userDataHeader.mpqHeaderOffset);
            header.offset = userDataHeader.mpqHeaderOffset;
            header.userDataHeader = userDataHeader;
        }
        return header;
    }
    readMPQHeader(offset = 0) {
        let data = this.file.slice(offset, offset + 32);
        let header = new mpqFileHeaders_1.MPQFileHeader(data);
        if (header.formatVersion === 1) {
            let extData = this.file.slice(offset + 32, offset + 32 + 12);
            Object.assign(header, new mpqFileHeaderExt_1.MPQFileHeaderExt(extData));
        }
        return header;
    }
    readMPQUserDataHeader() {
        let data = this.file.slice(0, 16);
        let header = new mpqUserDataHeader_1.MPQUserDataHeader(data);
        header.content = this.file.slice(16, 16 + header.userDataHeaderSize);
        return header;
    }
    readTable(tableType) {
        let type;
        switch (tableType) {
            case TableType.block:
                type = mpqBlockTableEntry_1.MPQBlockTableEntry;
                break;
            case TableType.hash:
                type = mpqHashTableEntry_1.MPQHashTableEntry;
                break;
            default:
                throw new Error('Invalid Table Type');
        }
        let tableOffset = this.header[TableType[tableType] + 'TableOffset'];
        let tableEntries = this.header[TableType[tableType] + 'TableEntries'];
        let key = this.hash(`(${TableType[tableType]} table)`, 'TABLE');
        let data = this.file.slice(tableOffset + this.header.offset, tableOffset + this.header.offset + tableEntries + 16);
        data = this.decrypt(data, key);
        console.log('data', data);
        let entries = [];
        console.log(data.length);
        for (let i = 0; i < tableEntries; i += 1) {
            console.log('index', i);
            entries[i] = new type(data.slice(i * 16, i * 16 + 16));
        }
        return entries;
    }
    getHashTableEntry(filename) {
        let hashA = this.hash(filename, 'HASH_A');
        let hashB = this.hash(filename, 'HASH_B');
        let entry = this.hashTable.find(te => te.hashA === hashA && te.hashB === hashB);
        return entry;
    }
    decompress(data) {
        let compressionType = data.readUInt8(0);
        if (compressionType === 0)
            return data;
        else if (compressionType === 2)
            return zlib_1.unzipSync(data.slice(1));
        else if (compressionType === 16)
            return bzip.decode(data.slice(1));
        else
            throw new Error('Unsupported Compression Type');
    }
    readFile(filename, forceDecompress) {
        let hashEntry = this.getHashTableEntry(filename);
        if (!hashEntry)
            return null;
        let blockEntry = this.blockTable[hashEntry.blockTableIndex];
        if (blockEntry.flags & MPQ_FILE_EXISTS) {
            if (blockEntry.archivedSize === 0)
                return null;
            let offset = blockEntry.offset + this.header.offset;
            let fileData = this.file.slice(offset, offset + blockEntry.archivedSize);
            if (blockEntry.flags & MPQ_FILE_ENCRYPTED) {
                throw new Error('Encryption not supported');
            }
            if (!(blockEntry.flags & MPQ_FILE_SINGLE_UNIT)) {
                // throw new Error('Single Unit not implemented');
                let sectorSize = 512 << this.header.sectorSizeShift;
                let sectors = Math.trunc(blockEntry.size / sectorSize) + 1;
                let crc;
                if (blockEntry.flags & MPQ_FILE_SECTOR_CRC) {
                    crc = true;
                    sectors++;
                }
                else {
                    crc = false;
                }
                let positions = [], i;
                for (i = 0; i < (sectors + i); i += 1) {
                    positions[i] = fileData.readUInt32LE(i * 4);
                }
                let ln = positions.length - (crc ? 2 : 1);
                let result = new Buffer(0);
                let sectorBytesLeft = blockEntry.size;
                for (i = 0; i < ln; i += 1) {
                    let sector = fileData.slice(positions[i], positions[i + 1]);
                    if ((blockEntry.flags & MPQ_FILE_COMPRESS) && (forceDecompress || (sectorBytesLeft > sector.length))) {
                        sector = this.decompress(sector);
                    }
                    sectorBytesLeft -= sector.length;
                    result = Buffer.concat([result, sector]);
                }
                fileData = result;
            }
            else {
                if ((blockEntry.flags & MPQ_FILE_COMPRESS) && (forceDecompress || (blockEntry.size > blockEntry.archivedSize))) {
                    fileData = this.decompress(fileData);
                }
            }
            return fileData;
        }
    }
    extract() {
        if (this.files) {
            return this.files.map(filename => [filename, this.readFile(filename)]);
        }
        else {
            throw new Error('Can\'t extract whole archive without listfile.');
        }
    }
    extractToDisc() {
        let extension = path_1.extname(this.fileName);
        let archiveName = path_1.basename(this.fileName, extension);
        let dirName = path_1.join(process.cwd(), archiveName);
        try {
            fs_1.statSync(dirName);
        }
        catch (e) {
            fs_1.mkdirSync(dirName);
        }
        process.chdir(archiveName);
        this.extract().forEach(pair => {
            fs_1.writeFileSync(pair[0], pair[1] || '');
        });
    }
    extractFiles(filenames) {
        filenames.forEach(fn => fs_1.writeFileSync(fn, this.readFile(fn)));
    }
    printHeaders() {
        console.log('MPQ archive header');
        console.log('------------------');
        for (let key in this.header) {
            if (key === 'userDataHeader')
                continue;
            console.log(key + ' - ' + this.header[key]);
        }
        if (this.header.userDataHeader) {
            console.log();
            console.log('MPQ user data header');
            console.log('--------------------');
            console.log();
            for (let key in this.header.userDataHeader) {
                console.log(key + ' - ' + this.header.userDataHeader[key]);
            }
        }
        console.log();
    }
    leadingChar(str, ch, ln, after) {
        str = '' + str;
        while (str.length < ln) {
            str = after ? str + ch : ch + str;
        }
        return str;
    }
    formatWord(data, ln) {
        return this.leadingChar(data.toString(16).toUpperCase(), '0', ln);
    }
    hash(str, hashType) {
        let seed1 = Long.fromValue(0x7FED7FED);
        let seed2 = Long.fromValue(0xEEEEEEEE);
        let value;
        for (let char of str.toUpperCase()) {
            let charCP;
            console.log(char);
            if (isNaN(parseInt(char, 10)))
                char = char.codePointAt(0);
            value = Long.fromValue(this.encryptionTable[(hashTypes[hashType] << 8) + char]);
            seed1 = value.xor(seed1.add(seed2)).and(0xFFFFFFFF);
            seed2 = seed1.add(seed2).add(char).add(seed2.shiftLeft(5)).add(3).and(0xFFFFFFFF);
        }
        return seed1.toNumber();
    }
    decrypt(data, key) {
        let result = new Buffer(data.length);
        let length = data.length / 4;
        let seed1 = Long.fromValue(key);
        let seed2 = Long.fromValue(0xEEEEEEEE);
        console.log(key);
        console.log(seed1);
        for (let i = 0; i < length; i += 1) {
            seed2 = seed2.add(this.encryptionTable[0x400 + (seed1 & 0xFF)]);
            seed2 = seed2.and(0xFFFFFFFF);
            let value = Long.fromValue(data.readUInt32LE(i * 4));
            value = value.xor(seed1.add(seed2)).and(0xFFFFFFFF);
            seed1 = seed1.xor(-1).shiftLeft(0x15).add(0x11111111).or(seed1.shiftRight(0x0B));
            seed1 = seed1.and(0xFFFFFFFF);
            seed2 = value.add(seed2).add(seed2.shiftLeft(5)).add(3).and(0xFFFFFFFF);
            result.writeUInt32BE(value.toNumber(), i * 4);
        }
        return result;
    }
}
exports.MPQArchive = MPQArchive;
var TableType;
(function (TableType) {
    TableType[TableType["Unknown"] = 0] = "Unknown";
    TableType[TableType["hash"] = 1] = "hash";
    TableType[TableType["block"] = 2] = "block";
})(TableType || (TableType = {}));
const hashTypes = {
    'TABLE_OFFSET': 0,
    'HASH_A': 1,
    'HASH_B': 2,
    'TABLE': 3
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tcHEvbW9kZWxzL21wcUFyY2hpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHFCQUFpRSxJQUFJLENBQUMsQ0FBQTtBQUN0RSx1QkFBMEIsTUFBTSxDQUFDLENBQUE7QUFDakMsdUJBQXdDLE1BQU0sQ0FBQyxDQUFBO0FBQy9DLE1BQVksSUFBSSxXQUFNLE1BQU0sQ0FBQyxDQUFBO0FBRTdCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUVsQyxvQ0FBa0MscUJBQXFCLENBQUMsQ0FBQTtBQUN4RCxxQ0FBbUMsc0JBQXNCLENBQUMsQ0FBQTtBQUMxRCxvQ0FBa0MscUJBQXFCLENBQUMsQ0FBQTtBQUN4RCxpQ0FBOEIsa0JBQWtCLENBQUMsQ0FBQTtBQUNqRCxtQ0FBaUMsb0JBQW9CLENBQUMsQ0FBQTtBQUN0RCxNQUFNLGdCQUFnQixHQUFRLFVBQVUsQ0FBQztBQUN6QyxNQUFNLGlCQUFpQixHQUFPLFVBQVUsQ0FBQztBQUN6QyxNQUFNLGtCQUFrQixHQUFPLFVBQVUsQ0FBQztBQUMxQyxNQUFNLGdCQUFnQixHQUFPLFVBQVUsQ0FBQztBQUN4QyxNQUFNLG9CQUFvQixHQUFJLFVBQVUsQ0FBQztBQUN6QyxNQUFNLHNCQUFzQixHQUFHLFVBQVUsQ0FBQztBQUMxQyxNQUFNLG1CQUFtQixHQUFPLFVBQVUsQ0FBQztBQUMzQyxNQUFNLGVBQWUsR0FBVSxVQUFVLENBQUM7QUFFMUM7SUErQkUsWUFBWSxRQUF5QixFQUFFLFFBQVEsR0FBRyxLQUFLO1FBZ09oRCxtQkFBYyxHQUFHO1lBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QixDQUFDLENBQUM7WUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO1lBQ3hELElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxD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QUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDakYsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDOUIsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRXhFLE1BQU0sQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNoRCxDQUFDO1FBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNoQixDQUFDO0FBSUgsQ0FBQztBQWxWWSxrQkFBVSxhQWtWdEIsQ0FBQTtBQUdELElBQUssU0FJSjtBQUpELFdBQUssU0FBUztJQUNaLCtDQUFPLENBQUE7SUFDUCx5Q0FBSSxDQUFBO0lBQ0osMkNBQUssQ0FBQTtBQUNQLENBQUMsRUFKSSxTQUFTLEtBQVQsU0FBUyxRQUliO0FBRUQsTUFBTSxTQUFTLEdBQUc7SUFDakIsY0FBYyxFQUFFLENBQUM7SUFDakIsUUFBUSxFQUFJLENBQUM7SUFDYixRQUFRLEVBQUksQ0FBQztJQUNiLE9BQU8sRUFBSSxDQUFDO0NBQ1osQ0FBQyIsImZpbGUiOiJzcmMvbXBxL21vZGVscy9tcHFBcmNoaXZlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVhZEZpbGVTeW5jLCBzdGF0U3luYywgd3JpdGVGaWxlU3luYywgbWtkaXJTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgdW56aXBTeW5jIH0gZnJvbSAnemxpYic7XG5pbXBvcnQgeyBleHRuYW1lLCBiYXNlbmFtZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgTG9uZyBmcm9tICdsb25nJztcblxuY29uc3QgYnppcCA9IHJlcXVpcmUoJ3NlZWstYnppcCcpO1xuXG5pbXBvcnQgeyBNUFFVc2VyRGF0YUhlYWRlciB9IGZyb20gJy4vbXBxVXNlckRhdGFIZWFkZXInO1xuaW1wb3J0IHsgTVBRQmxvY2tUYWJsZUVudHJ5IH0gZnJvbSAnLi9tcHFCbG9ja1RhYmxlRW50cnknO1xuaW1wb3J0IHsgTVBRSGFzaFRhYmxlRW50cnkgfSBmcm9tICcuL21wcUhhc2hUYWJsZUVudHJ5JztcbmltcG9ydCB7IE1QUUZpbGVIZWFkZXIgfSBmcm9tICcuL21wcUZpbGVIZWFkZXJzJztcbmltcG9ydCB7IE1QUUZpbGVIZWFkZXJFeHQgfSBmcm9tICcuL21wcUZpbGVIZWFkZXJFeHQnO1xuY29uc3QgTVBRX0ZJTEVfSU1QTE9ERSBcdFx0XHQgID0gMHgwMDAwMDEwMDtcbmNvbnN0IE1QUV9GSUxFX0NPTVBSRVNTIFx0XHQgID0gMHgwMDAwMDIwMDtcbmNvbnN0IE1QUV9GSUxFX0VOQ1JZUFRFRCBcdFx0ICA9IDB4MDAwMTAwMDA7XG5jb25zdCBNUFFfRklMRV9GSVhfS0VZXHRcdFx0ICA9IDB4MDAwMjAwMDA7XG5jb25zdCBNUFFfRklMRV9TSU5HTEVfVU5JVFx0XHQ9IDB4MDEwMDAwMDA7XG5jb25zdCBNUFFfRklMRV9ERUxFVEVfTUFSS0VSXHQ9IDB4MDIwMDAwMDA7XG5jb25zdCBNUFFfRklMRV9TRUNUT1JfQ1JDXHQgXHQgID0gMHgwNDAwMDAwMDtcbmNvbnN0IE1QUV9GSUxFX0VYSVNUU1x0XHQgXHQgICAgPSAweDgwMDAwMDAwO1xuXG5leHBvcnQgY2xhc3MgTVBRQXJjaGl2ZSB7XG4gIHB1YmxpYyBmaWxlTmFtZTogc3RyaW5nO1xuICBwdWJsaWMgZmlsZTogQnVmZmVyO1xuICBwdWJsaWMgZmlsZXM6IEFycmF5PHN0cmluZz47XG5cbiAgcHVibGljIGhlYWRlcjogTVBRRmlsZUhlYWRlcjtcbiAgcHVibGljIGhhc2hUYWJsZTogQXJyYXk8TVBRSGFzaFRhYmxlRW50cnk+O1xuICBwdWJsaWMgYmxvY2tUYWJsZTogQXJyYXk8TVBRQmxvY2tUYWJsZUVudHJ5PjtcblxuICBwcml2YXRlIGxpc3RmaWxlOiBib29sZWFuO1xuXG4gIGdldCBlbmNyeXB0aW9uVGFibGUoKTogYW55IHtcbiAgICBsZXQgdGFibGUgPSB7fTtcbiAgICBsZXQgc2VlZCA9IExvbmcuZnJvbVZhbHVlKDB4MDAxMDAwMDEpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNTY7IGkgKz0gMSkge1xuICAgICAgbGV0IGluZGV4ID0gaTtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgNTsgaiArPSAxKSB7XG4gICAgICAgIHNlZWQgPSBzZWVkLm11bCgxMjUpLmFkZCgzKS5tb2QoMHgyQUFBQUIpO1xuICAgICAgICBsZXQgdDEgPSBzZWVkLmFuZCgweEZGRkYpLnNoaWZ0TGVmdCgweDEwKTtcbiAgICAgICAgXG4gICAgICAgIHNlZWQgPSBzZWVkLm11bCgxMjUpLmFkZCgzKS5tb2QoMHgyQUFBQUIpO1xuICAgICAgICBsZXQgdDIgPSBzZWVkLmFuZCgweEZGRkYpO1xuICAgICAgICBcbiAgICAgICAgdGFibGVbaW5kZXhdID0gdDEub3IodDIpLnRvTnVtYmVyKCk7XG4gICAgICAgIGluZGV4ICs9IDB4MTAwO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGFibGU7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihmaWxlTmFtZTogc3RyaW5nIHwgQnVmZmVyLCBsaXN0RmlsZSA9IGZhbHNlKSB7XG4gICAgdGhpcy5saXN0ZmlsZSA9ICEhbGlzdEZpbGU7XG5cbiAgICBpZiAoZmlsZU5hbWUgaW5zdGFuY2VvZiBCdWZmZXIpIHtcbiAgICAgIHRoaXMuZmlsZSA9IGZpbGVOYW1lO1xuICAgICAgdGhpcy5maWxlTmFtZSA9ICcnO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZpbGVOYW1lID0gZmlsZU5hbWU7XG4gICAgICB0aGlzLmZpbGUgPSByZWFkRmlsZVN5bmMoZmlsZU5hbWUpO1xuICAgIH1cbiAgICB0aGlzLmhlYWRlciA9IHRoaXMucmVhZEhlYWRlcigpO1xuICAgIGNvbnNvbGUubG9nKHRoaXMuaGVhZGVyKTtcbiAgICB0aGlzLmhhc2hUYWJsZSA9IHRoaXMucmVhZFRhYmxlKFRhYmxlVHlwZS5oYXNoKTtcbiAgICB0aGlzLmJsb2NrVGFibGUgPSB0aGlzLnJlYWRUYWJsZShUYWJsZVR5cGUuYmxvY2spO1xuICAgIFxuICAgIGlmICh0aGlzLmxpc3RmaWxlKSB7XG4gICAgICB0aGlzLmZpbGVzID0gdGhpcy5yZWFkRmlsZSgnKGxpc3RmaWxlKScpLnRvU3RyaW5nKCkudHJpbSgpLnNwbGl0KCdcXHJcXG4nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5maWxlcyA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZWFkSGVhZGVyKCk6IE1QUUZpbGVIZWFkZXIge1xuICAgIGxldCBtYWdpYyA9IHRoaXMuZmlsZS50b1N0cmluZygndXRmOCcsIDAsIDQpO1xuICAgIGxldCBoZWFkZXI6IE1QUUZpbGVIZWFkZXI7XG4gICAgaWYgKG1hZ2ljID09PSAnTVBRXFx4MWEnKSB7XG4gICAgICBoZWFkZXIgPSB0aGlzLnJlYWRNUFFIZWFkZXIoKTtcbiAgICAgIGhlYWRlci5vZmZzZXQgPSAwO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgdXNlckRhdGFIZWFkZXI6IE1QUVVzZXJEYXRhSGVhZGVyID0gdGhpcy5yZWFkTVBRVXNlckRhdGFIZWFkZXIoKTtcbiAgICAgIGhlYWRlciA9IHRoaXMucmVhZE1QUUhlYWRlcih1c2VyRGF0YUhlYWRlci5tcHFIZWFkZXJPZmZzZXQpO1xuICAgICAgaGVhZGVyLm9mZnNldCA9IHVzZXJEYXRhSGVhZGVyLm1wcUhlYWRlck9mZnNldDtcbiAgICAgIGhlYWRlci51c2VyRGF0YUhlYWRlciA9IHVzZXJEYXRhSGVhZGVyO1xuICAgIH1cblxuICAgIHJldHVybiBoZWFkZXI7XG4gIH1cblxuICBwcml2YXRlIHJlYWRNUFFIZWFkZXIob2Zmc2V0ID0gMCkge1xuICAgIGxldCBkYXRhID0gdGhpcy5maWxlLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgMzIpO1xuICAgIGxldCBoZWFkZXIgPSBuZXcgTVBRRmlsZUhlYWRlcihkYXRhKTtcblxuICAgIGlmIChoZWFkZXIuZm9ybWF0VmVyc2lvbiA9PT0gMSkge1xuICAgICAgbGV0IGV4dERhdGEgPSB0aGlzLmZpbGUuc2xpY2Uob2Zmc2V0ICsgMzIsIG9mZnNldCArIDMyICsgMTIpO1xuICAgICAgT2JqZWN0LmFzc2lnbihoZWFkZXIsIG5ldyBNUFFGaWxlSGVhZGVyRXh0KGV4dERhdGEpKTtcbiAgICB9XG4gICAgcmV0dXJuIGhlYWRlcjtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZE1QUVVzZXJEYXRhSGVhZGVyKCkge1xuICAgIGxldCBkYXRhID0gdGhpcy5maWxlLnNsaWNlKDAsIDE2KTtcbiAgICBsZXQgaGVhZGVyID0gbmV3IE1QUVVzZXJEYXRhSGVhZGVyKGRhdGEpO1xuICAgIGhlYWRlci5jb250ZW50ID0gdGhpcy5maWxlLnNsaWNlKDE2LCAxNiArIGhlYWRlci51c2VyRGF0YUhlYWRlclNpemUpO1xuXG4gICAgcmV0dXJuIGhlYWRlcjtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZFRhYmxlKHRhYmxlVHlwZTogVGFibGVUeXBlKSB7XG4gICAgbGV0IHR5cGU7XG4gICAgc3dpdGNoICh0YWJsZVR5cGUpIHtcbiAgICAgIGNhc2UgVGFibGVUeXBlLmJsb2NrOlxuICAgICAgICB0eXBlID0gTVBRQmxvY2tUYWJsZUVudHJ5O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVGFibGVUeXBlLmhhc2g6XG4gICAgICAgIHR5cGUgPSBNUFFIYXNoVGFibGVFbnRyeTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgVGFibGUgVHlwZScpO1xuICAgIH1cblxuICAgIGxldCB0YWJsZU9mZnNldCA9IHRoaXMuaGVhZGVyW1RhYmxlVHlwZVt0YWJsZVR5cGVdICsgJ1RhYmxlT2Zmc2V0J107XG4gICAgbGV0IHRhYmxlRW50cmllcyA9IHRoaXMuaGVhZGVyW1RhYmxlVHlwZVt0YWJsZVR5cGVdICsgJ1RhYmxlRW50cmllcyddO1xuICAgIGxldCBrZXkgPSB0aGlzLmhhc2goYCgke1RhYmxlVHlwZVt0YWJsZVR5cGVdfSB0YWJsZSlgLCAnVEFCTEUnKTtcbiAgICBsZXQgZGF0YSA9IHRoaXMuZmlsZS5zbGljZSh0YWJsZU9mZnNldCArIHRoaXMuaGVhZGVyLm9mZnNldCwgdGFibGVPZmZzZXQgKyB0aGlzLmhlYWRlci5vZmZzZXQgKyB0YWJsZUVudHJpZXMgKyAxNik7XG5cbiAgICBkYXRhID0gdGhpcy5kZWNyeXB0KGRhdGEsIGtleSk7XG4gICAgY29uc29sZS5sb2coJ2RhdGEnLCBkYXRhKTtcbiAgICBcbiAgICBsZXQgZW50cmllcyA9IFtdO1xuICAgIGNvbnNvbGUubG9nKGRhdGEubGVuZ3RoKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhYmxlRW50cmllczsgaSArPSAxKSB7XG4gICAgICBjb25zb2xlLmxvZygnaW5kZXgnLCBpKTtcbiAgICAgIGVudHJpZXNbaV0gPSBuZXcgdHlwZShkYXRhLnNsaWNlKGkgKiAxNiwgaSAqIDE2ICsgMTYpKTtcblx0ICB9XG4gICAgcmV0dXJuIGVudHJpZXM7XG4gIH1cblxuICBwcml2YXRlIGdldEhhc2hUYWJsZUVudHJ5KGZpbGVuYW1lOiBzdHJpbmcpIHtcbiAgICBsZXQgaGFzaEEgPSB0aGlzLmhhc2goZmlsZW5hbWUsICdIQVNIX0EnKTtcbiAgICBsZXQgaGFzaEIgPSB0aGlzLmhhc2goZmlsZW5hbWUsICdIQVNIX0InKTtcblxuICAgIGxldCBlbnRyeSA9IHRoaXMuaGFzaFRhYmxlLmZpbmQodGUgPT4gdGUuaGFzaEEgPT09IGhhc2hBICYmIHRlLmhhc2hCID09PSBoYXNoQik7XG4gICAgcmV0dXJuIGVudHJ5O1xuICB9XG5cbiAgcHJpdmF0ZSBkZWNvbXByZXNzKGRhdGE6IEJ1ZmZlcikge1xuICAgIGxldCBjb21wcmVzc2lvblR5cGUgPSBkYXRhLnJlYWRVSW50OCgwKTtcbiAgICBpZiAoY29tcHJlc3Npb25UeXBlID09PSAwKSByZXR1cm4gZGF0YTtcbiAgICBlbHNlIGlmIChjb21wcmVzc2lvblR5cGUgPT09IDIpIHJldHVybiB1bnppcFN5bmMoZGF0YS5zbGljZSgxKSk7XG4gICAgZWxzZSBpZiAoY29tcHJlc3Npb25UeXBlID09PSAxNikgcmV0dXJuIGJ6aXAuZGVjb2RlKGRhdGEuc2xpY2UoMSkpO1xuICAgIGVsc2UgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCBDb21wcmVzc2lvbiBUeXBlJyk7XG4gIH1cblxuICBwcml2YXRlIHJlYWRGaWxlKGZpbGVuYW1lOiBzdHJpbmcsIGZvcmNlRGVjb21wcmVzcz86IGJvb2xlYW4pOiBCdWZmZXIge1xuICAgIGxldCBoYXNoRW50cnkgPSB0aGlzLmdldEhhc2hUYWJsZUVudHJ5KGZpbGVuYW1lKTtcbiAgICBpZiAoIWhhc2hFbnRyeSkgcmV0dXJuIG51bGw7XG5cbiAgICBsZXQgYmxvY2tFbnRyeSA9IHRoaXMuYmxvY2tUYWJsZVtoYXNoRW50cnkuYmxvY2tUYWJsZUluZGV4XTtcblxuICAgIGlmIChibG9ja0VudHJ5LmZsYWdzICYgTVBRX0ZJTEVfRVhJU1RTKSB7XG4gICAgICBpZiAoYmxvY2tFbnRyeS5hcmNoaXZlZFNpemUgPT09IDApIHJldHVybiBudWxsO1xuXG4gICAgICBsZXQgb2Zmc2V0ID0gYmxvY2tFbnRyeS5vZmZzZXQgKyB0aGlzLmhlYWRlci5vZmZzZXQ7XG4gICAgICBsZXQgZmlsZURhdGEgPSB0aGlzLmZpbGUuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyBibG9ja0VudHJ5LmFyY2hpdmVkU2l6ZSk7XG5cbiAgICAgIGlmIChibG9ja0VudHJ5LmZsYWdzICYgTVBRX0ZJTEVfRU5DUllQVEVEKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRW5jcnlwdGlvbiBub3Qgc3VwcG9ydGVkJyk7XG4gICAgICB9XG5cbiAgICAgIGlmICghKGJsb2NrRW50cnkuZmxhZ3MgJiBNUFFfRklMRV9TSU5HTEVfVU5JVCkpIHtcbiAgICAgICAgLy8gdGhyb3cgbmV3IEVycm9yKCdTaW5nbGUgVW5pdCBub3QgaW1wbGVtZW50ZWQnKTtcblxuICAgICAgICBsZXQgc2VjdG9yU2l6ZSA9IDUxMiA8PCB0aGlzLmhlYWRlci5zZWN0b3JTaXplU2hpZnQ7XG4gICAgICAgIGxldCBzZWN0b3JzID0gTWF0aC50cnVuYyhibG9ja0VudHJ5LnNpemUgLyBzZWN0b3JTaXplKSArIDE7XG5cbiAgICAgICAgbGV0IGNyYztcblxuICAgICAgICBpZiAoYmxvY2tFbnRyeS5mbGFncyAmIE1QUV9GSUxFX1NFQ1RPUl9DUkMpIHtcbiAgICAgICAgICBjcmMgPSB0cnVlO1xuICAgICAgICAgIHNlY3RvcnMrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjcmMgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBwb3NpdGlvbnMgPSBbXSwgaTtcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IChzZWN0b3JzICsgaSk7IGkgKz0gMSkge1xuICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IGZpbGVEYXRhLnJlYWRVSW50MzJMRShpICogNCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbG4gPSBwb3NpdGlvbnMubGVuZ3RoIC0gKGNyYyA/IDIgOiAxKTtcbiAgICAgICAgbGV0IHJlc3VsdCA9IG5ldyBCdWZmZXIoMCk7XG4gICAgICAgIGxldCBzZWN0b3JCeXRlc0xlZnQgPSBibG9ja0VudHJ5LnNpemU7XG5cbiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxuOyBpKz0gMSkge1xuICAgICAgICAgIGxldCBzZWN0b3IgPSBmaWxlRGF0YS5zbGljZShwb3NpdGlvbnNbaV0sIHBvc2l0aW9uc1tpICsgMV0pO1xuICAgICAgICAgIGlmICgoYmxvY2tFbnRyeS5mbGFncyAmIE1QUV9GSUxFX0NPTVBSRVNTKSAmJiAoZm9yY2VEZWNvbXByZXNzIHx8IChzZWN0b3JCeXRlc0xlZnQgPiBzZWN0b3IubGVuZ3RoKSkpIHtcbiAgICAgICAgICAgIHNlY3RvciA9IHRoaXMuZGVjb21wcmVzcyhzZWN0b3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBzZWN0b3JCeXRlc0xlZnQgLT0gc2VjdG9yLmxlbmd0aDtcblxuICAgICAgICAgIHJlc3VsdCA9IEJ1ZmZlci5jb25jYXQoW3Jlc3VsdCwgc2VjdG9yXSk7XG4gICAgICAgIH1cbiAgICAgICAgZmlsZURhdGEgPSByZXN1bHQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoKGJsb2NrRW50cnkuZmxhZ3MgJiBNUFFfRklMRV9DT01QUkVTUykgJiYgKGZvcmNlRGVjb21wcmVzcyB8fCAoYmxvY2tFbnRyeS5zaXplID4gYmxvY2tFbnRyeS5hcmNoaXZlZFNpemUpKSkge1xuICAgICAgICAgIGZpbGVEYXRhID0gdGhpcy5kZWNvbXByZXNzKGZpbGVEYXRhKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGZpbGVEYXRhO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdCgpIHtcbiAgICBpZiAodGhpcy5maWxlcykge1xuICAgICAgcmV0dXJuIHRoaXMuZmlsZXMubWFwKGZpbGVuYW1lID0+IFtmaWxlbmFtZSwgdGhpcy5yZWFkRmlsZShmaWxlbmFtZSldKVxuICAgIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5cXCd0IGV4dHJhY3Qgd2hvbGUgYXJjaGl2ZSB3aXRob3V0IGxpc3RmaWxlLicpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdFRvRGlzYygpIHtcbiAgICBsZXQgZXh0ZW5zaW9uID0gZXh0bmFtZSh0aGlzLmZpbGVOYW1lKTtcbiAgICBsZXQgYXJjaGl2ZU5hbWUgPSBiYXNlbmFtZSh0aGlzLmZpbGVOYW1lLCBleHRlbnNpb24pO1xuICAgIGxldCBkaXJOYW1lID0gam9pbihwcm9jZXNzLmN3ZCgpLCBhcmNoaXZlTmFtZSk7XG5cbiAgICB0cnkge1xuICAgICAgc3RhdFN5bmMoZGlyTmFtZSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbWtkaXJTeW5jKGRpck5hbWUpO1xuICAgIH1cblxuICAgIHByb2Nlc3MuY2hkaXIoYXJjaGl2ZU5hbWUpO1xuXG4gICAgdGhpcy5leHRyYWN0KCkuZm9yRWFjaChwYWlyID0+IHtcbiAgICAgIHdyaXRlRmlsZVN5bmMocGFpclswXSwgcGFpclsxXSB8fCAnJyk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZXh0cmFjdEZpbGVzKGZpbGVuYW1lczogQXJyYXk8c3RyaW5nPikge1xuICAgIGZpbGVuYW1lcy5mb3JFYWNoKGZuID0+IHdyaXRlRmlsZVN5bmMoZm4sIHRoaXMucmVhZEZpbGUoZm4pKSk7XG4gIH1cblxuICBwdWJsaWMgcHJpbnRIZWFkZXJzKCkge1xuICAgIGNvbnNvbGUubG9nKCdNUFEgYXJjaGl2ZSBoZWFkZXInKTtcbiAgICBjb25zb2xlLmxvZygnLS0tLS0tLS0tLS0tLS0tLS0tJyk7XG4gICAgZm9yIChsZXQga2V5IGluIHRoaXMuaGVhZGVyKSB7XG4gICAgICBpZiAoa2V5ID09PSAndXNlckRhdGFIZWFkZXInKSBjb250aW51ZTtcbiAgICAgIGNvbnNvbGUubG9nKGtleSArICcgLSAnICsgdGhpcy5oZWFkZXJba2V5XSk7XG4gICAgfVxuICAgIFxuICAgIGlmICh0aGlzLmhlYWRlci51c2VyRGF0YUhlYWRlcikge1xuICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgIGNvbnNvbGUubG9nKCdNUFEgdXNlciBkYXRhIGhlYWRlcicpO1xuICAgICAgY29uc29sZS5sb2coJy0tLS0tLS0tLS0tLS0tLS0tLS0tJyk7XG4gICAgICBjb25zb2xlLmxvZygpO1xuICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuaGVhZGVyLnVzZXJEYXRhSGVhZGVyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGtleSArICcgLSAnICsgdGhpcy5oZWFkZXIudXNlckRhdGFIZWFkZXJba2V5XSk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKCk7XG4gIH1cblxuICBwcml2YXRlIGxlYWRpbmdDaGFyKHN0ciwgY2gsIGxuLCBhZnRlcj8pIHtcbiAgICBzdHIgPSAnJyArIHN0cjtcbiAgICB3aGlsZSAoc3RyLmxlbmd0aCA8IGxuKSB7XG4gICAgICBzdHIgPSBhZnRlciA/IHN0ciArIGNoIDogY2ggKyBzdHI7XG4gICAgfVxuICAgIHJldHVybiBzdHI7XG4gIH1cblxuICBwcml2YXRlIGZvcm1hdFdvcmQoZGF0YSwgbG4pIHtcbiAgICByZXR1cm4gdGhpcy5sZWFkaW5nQ2hhcihkYXRhLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpLCAnMCcsIGxuKTtcbiAgfVxuXG4gIHB1YmxpYyBwcmludEhhc2hUYWJsZSA9IGZ1bmN0aW9uKCkge1xuICAgIGNvbnNvbGUubG9nKCdNUFEgYXJjaGl2ZSBoYXNoIHRhYmxlJyk7XG4gICAgY29uc29sZS5sb2coJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0nKTtcbiAgICBjb25zb2xlLmxvZygnSGFzaCBBXFx0XFx0SGFzaCBCXFx0XFx0TG9jbFxcdFBsYXRcXHRCbG9ja0lkeCcpO1xuICAgIGxldCBmb3JtYXQgPSBbOCwgOCwgNCwgNCwgOF07XG4gICAgdGhpcy5oYXNoVGFibGUuZm9yRWFjaChlbnRyeSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhPYmplY3Qua2V5cyhlbnRyeSkubWFwKChrZXksIGkpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0V29yZChlbnRyeVtrZXldLCBmb3JtYXRbaV0pO1xuICAgICAgfSkuam9pbignXFx0JykpO1xuICAgIH0pO1xuICAgIGNvbnNvbGUubG9nKCk7XG4gIH07XG5cbiAgcHVibGljIHByaW50QmxvY2tUYWJsZSA9IGZ1bmN0aW9uKCkge1xuICAgIGNvbnNvbGUubG9nKCdNUFEgYXJjaGl2ZSBibG9jayB0YWJsZScpO1xuICAgIGNvbnNvbGUubG9nKCctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScpO1xuICAgIGNvbnNvbGUubG9nKCdPZmZzZXRcXHRcXHRBcmNoU2l6ZVxcdFJlYWxTaXplXFx0RmxhZ3MnKTtcbiAgICB0aGlzLmJsb2NrVGFibGUuZm9yRWFjaChlbnRyeSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhbXG4gICAgICAgIHRoaXMuZm9ybWF0V29yZChlbnRyeS5vZmZzZXQsIDgpLFxuICAgICAgICB0aGlzLmxlYWRpbmdDaGFyKGVudHJ5LmFyY2hpdmVkU2l6ZSwgJyAnLCA4KSxcbiAgICAgICAgdGhpcy5sZWFkaW5nQ2hhcihlbnRyeS5zaXplLCAnICcsIDgpLFxuICAgICAgICB0aGlzLmZvcm1hdFdvcmQoZW50cnkuZmxhZ3MsIDgpXG4gICAgICBdLmpvaW4oJ1xcdCcpKTtcbiAgICB9KTtcbiAgICBjb25zb2xlLmxvZygpO1xuICB9O1xuXG4gIHB1YmxpYyBwcmludEZpbGVzID0gZnVuY3Rpb24oKSB7XG4gICAgbGV0IHdpZHRoID0gdGhpcy5maWxlcy5yZWR1Y2UoKHRvcCwgZmlsZW5hbWUpID0+IE1hdGgubWF4KHRvcCwgZmlsZW5hbWUubGVuZ3RoKSwgMCksIGhhc2hFbnRyeSwgYmxvY2tFbnRyeTtcbiAgICBcbiAgICBjb25zb2xlLmxvZygnRmlsZXMnKTtcbiAgICBjb25zb2xlLmxvZygnLS0tLS0nKTtcbiAgICBmb3IgKGxldCBmaWxlbmFtZSBvZiB0aGlzLmZpbGVzKSB7XG4gICAgICBoYXNoRW50cnkgPSB0aGlzLmdldEhhc2hUYWJsZUVudHJ5KGZpbGVuYW1lKTtcbiAgICAgIGJsb2NrRW50cnkgPSB0aGlzLmJsb2NrVGFibGVbaGFzaEVudHJ5LmJsb2NrVGFibGVJbmRleF07XG4gICAgICBcbiAgICAgIGNvbnNvbGUubG9nKHRoaXMubGVhZGluZ0NoYXIoZmlsZW5hbWUsICcgJywgd2lkdGgsIHRydWUpICsgJyAnICsgdGhpcy5sZWFkaW5nQ2hhcihibG9ja0VudHJ5LnNpemUsICcgJywgOCkgKyAnIGJ5dGVzJyk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgaGFzaChzdHI6IHN0cmluZywgaGFzaFR5cGU6IHN0cmluZykge1xuICAgIGxldCBzZWVkMSA9IExvbmcuZnJvbVZhbHVlKDB4N0ZFRDdGRUQpO1xuICAgIGxldCBzZWVkMiA9IExvbmcuZnJvbVZhbHVlKDB4RUVFRUVFRUUpO1xuICAgIGxldCB2YWx1ZTtcbiAgICBmb3IgKGxldCBjaGFyIG9mIHN0ci50b1VwcGVyQ2FzZSgpKSB7XG4gICAgICBsZXQgY2hhckNQO1xuICAgICAgY29uc29sZS5sb2coY2hhcik7XG4gICAgICBpZiAoaXNOYU4ocGFyc2VJbnQoY2hhciwgMTApKSkgY2hhciA9IGNoYXIuY29kZVBvaW50QXQoMCk7XG5cbiAgICAgIHZhbHVlID0gTG9uZy5mcm9tVmFsdWUodGhpcy5lbmNyeXB0aW9uVGFibGVbKGhhc2hUeXBlc1toYXNoVHlwZV0gPDwgOCkgKyBjaGFyXSk7XG4gICAgICBzZWVkMSA9IHZhbHVlLnhvcihzZWVkMS5hZGQoc2VlZDIpKS5hbmQoMHhGRkZGRkZGRik7XG4gICAgICBzZWVkMiA9IHNlZWQxLmFkZChzZWVkMikuYWRkKGNoYXIpLmFkZChzZWVkMi5zaGlmdExlZnQoNSkpLmFkZCgzKS5hbmQoMHhGRkZGRkZGRik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNlZWQxLnRvTnVtYmVyKCk7XG4gIH1cblxuICBwcml2YXRlIGRlY3J5cHQoZGF0YTogQnVmZmVyLCBrZXkpIHtcbiAgICBsZXQgcmVzdWx0ID0gbmV3IEJ1ZmZlcihkYXRhLmxlbmd0aCk7XG4gICAgbGV0IGxlbmd0aCA9IGRhdGEubGVuZ3RoIC8gNDtcblxuICAgIGxldCBzZWVkMSA9IExvbmcuZnJvbVZhbHVlKGtleSk7XG4gICAgbGV0IHNlZWQyID0gTG9uZy5mcm9tVmFsdWUoMHhFRUVFRUVFRSk7XG4gICAgY29uc29sZS5sb2coa2V5KTtcbiAgICBjb25zb2xlLmxvZyhzZWVkMSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkge1xuICAgICAgc2VlZDIgPSBzZWVkMi5hZGQodGhpcy5lbmNyeXB0aW9uVGFibGVbMHg0MDAgKyAoc2VlZDEgJiAweEZGKV0pO1xuICAgICAgc2VlZDIgPSBzZWVkMi5hbmQoMHhGRkZGRkZGRik7XG4gICAgICBsZXQgdmFsdWUgPSBMb25nLmZyb21WYWx1ZShkYXRhLnJlYWRVSW50MzJMRShpICogNCkpO1xuICAgICAgdmFsdWUgPSB2YWx1ZS54b3Ioc2VlZDEuYWRkKHNlZWQyKSkuYW5kKDB4RkZGRkZGRkYpO1xuICAgICAgXG4gICAgICBzZWVkMSA9IHNlZWQxLnhvcigtMSkuc2hpZnRMZWZ0KDB4MTUpLmFkZCgweDExMTExMTExKS5vcihzZWVkMS5zaGlmdFJpZ2h0KDB4MEIpKTtcbiAgICAgIHNlZWQxID0gc2VlZDEuYW5kKDB4RkZGRkZGRkYpO1xuICAgICAgc2VlZDIgPSB2YWx1ZS5hZGQoc2VlZDIpLmFkZChzZWVkMi5zaGlmdExlZnQoNSkpLmFkZCgzKS5hbmQoMHhGRkZGRkZGRik7XG4gICAgICBcbiAgICAgIHJlc3VsdC53cml0ZVVJbnQzMkJFKHZhbHVlLnRvTnVtYmVyKCksIGkgKiA0KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG5cblxufVxuXG5cbmVudW0gVGFibGVUeXBlIHtcbiAgVW5rbm93bixcbiAgaGFzaCxcbiAgYmxvY2tcbn1cblxuY29uc3QgaGFzaFR5cGVzID0ge1xuXHQnVEFCTEVfT0ZGU0VUJzogMCxcblx0J0hBU0hfQSc6IFx0XHQxLFxuXHQnSEFTSF9CJzogXHRcdDIsXG5cdCdUQUJMRSc6IFx0XHQzXG59OyJdfQ==
